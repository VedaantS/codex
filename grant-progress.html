<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grant Progress Monitoring</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/dac0a9835a.js" crossorigin="anonymous"></script>
  <style>
    body { font-family: 'Space Grotesk', sans-serif; }
    .stroke-line { stroke: rgba(0,255,255,0.15); stroke-width: 0.5px; }
    .glass { backdrop-filter: blur(14px) saturate(180%); background: rgba(10, 10, 30, 0.06); }
    .holo-glow { box-shadow: 0 0 0.5px rgba(0,255,255,0.6), 0 0 8px rgba(0,255,255,0.2), 0 0 40px rgba(0,255,255,0.05); transition: box-shadow 0.4s ease-in-out; }
    .holo-glow:hover { box-shadow: 0 0 1px rgba(0,255,255,0.9), 0 0 12px rgba(0,255,255,0.4), 0 0 60px rgba(0,255,255,0.1); }
    .scanlines::before { content: ""; position: absolute; inset: 0;
      background-image: repeating-linear-gradient(to bottom, rgba(255,255,255,0.02) 0px, transparent 1px, transparent 4px);
      pointer-events: none; z-index: 10;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leader-line/1.0.7/leader-line.min.js"></script>
</head>
<body class="bg-black text-white antialiased overflow-x-hidden">
  <nav class="fixed top-0 w-full flex justify-between items-center px-10 py-4 glass border-b border-cyan-500/10 z-50" style="z-index: 11;">
    <a href="/" class="text-2xl font-bold tracking-wide text-cyan-300">atlantis [CODEX]</a>
    <ul class="flex space-x-8 text-sm">
      <li><a href="#" class="hover:text-cyan-400 transition">Home</a></li>
      <li><a href="/kdmap.html" class="hover:text-cyan-400 transition">Frontier</a></li>
      <li><a href="/chat.html" class="hover:text-cyan-400 transition">Chat</a></li>
      <li><a href="/profile.html" class="hover:text-cyan-400 transition">Profile</a></li>
    </ul>
  </nav>
  <section id="funder-grant-progress" class="py-20 px-8 mx-auto relative z-10 max-w-4xl">
    <svg class="absolute inset-0 w-full h-full" xmlns="http://www.w3.org/2000/svg" style="z-index:-1;">
      <defs>
        <pattern id="grid-funder-progress" width="80" height="80" patternUnits="userSpaceOnUse">
          <path d="M80 0 L0 0 0 80" class="stroke-line" />
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#grid-funder-progress)" />
    </svg>
    <h2 class="text-3xl font-bold text-cyan-200 mb-6">Monitor Grant Progress</h2>
    <div class="mb-6">
      <label class="text-cyan-100/80 mr-2">Funded Project:</label>
      <select id="funder-progress-project-select" class="p-2 glass border border-cyan-400/20 rounded text-cyan-100 bg-transparent">
        <!-- Populated by JS -->
      </select>
    </div>
    <div id="funder-progress-details" class="glass rounded-2xl p-8 holo-glow scanlines">
      <!-- Progress details will be rendered here -->
    </div>
  </section>
  <div class="h-32"></div>
  <footer class="py-8 text-center glass mt-16 relative z-10 border-t border-cyan-500/10">
    <p class="text-sm text-cyan-200">&copy; 2025 Atlantis. All rights reserved.</p>
  </footer>
  <script>
  async function fetchFundedProjectsAndRender() {
    const token = localStorage.getItem('access_token');
    if (!token) return;
    // Fetch all grants for this funder
    const grantsResp = await fetch('/grants', { headers: { 'Authorization': 'Bearer ' + token } });
    if (!grantsResp.ok) return;
    const grants = await grantsResp.json();
    const funderGrantIds = grants.map(g => g.id);
    let fundedProjects = [];
    // For each grant, fetch accepted/awarded applications
    for (const grant of grants) {
      const appsResp = await fetch(`/grants/${grant.id}/applicants`, { headers: { 'Authorization': 'Bearer ' + token } });
      if (!appsResp.ok) continue;
      const apps = await appsResp.json();
      for (const app of apps) {
        if (app.status === 'shortlisted' || app.status === 'awarded') {
          // Fetch project details
          const projResp = await fetch(`/projects/${app.project_id}`, { headers: { 'Authorization': 'Bearer ' + token } });
          if (!projResp.ok) continue;
          const project = await projResp.json();
          // Fetch applicant (owner) details
          let applicantName = app.project_id;
          if (project.owner_id) {
            const userResp = await fetch(`/users/${project.owner_id}`, { headers: { 'Authorization': 'Bearer ' + token } });
            if (userResp.ok) {
              const user = await userResp.json();
              applicantName = user.name || user.email || project.owner_id;
            }
          }
          // Fetch experiment steps (protocol versions)
          let steps = [];
          let debugMsg = '';
          try {
            const expResp = await fetch(`/projects/${project.id}/experiment`, { headers: { 'Authorization': 'Bearer ' + token } });
            if (expResp.ok) {
              const exp = await expResp.json();
              debugMsg += `[exp:${exp.id}]`;
              const versionsResp = await fetch(`/experiments/${exp.id}/versions`, { headers: { 'Authorization': 'Bearer ' + token } });
              if (versionsResp.ok) {
                const versions = await versionsResp.json();
                if (Array.isArray(versions) && versions.length > 0) {
                  const latest = versions.reduce((a, b) => new Date(a.created_at) > new Date(b.created_at) ? a : b);
                  debugMsg += `[ver:${latest.id}]`;
                  const stepsResp = await fetch(`/versions/${latest.id}/steps`, { headers: { 'Authorization': 'Bearer ' + token } });
                  if (stepsResp.ok) {
                    steps = await stepsResp.json();
                    debugMsg += `[steps:${steps.length}]`;
                  } else {
                    debugMsg += '[steps:fail]';
                  }
                } else {
                  debugMsg += '[no versions]';
                }
              } else {
                debugMsg += '[ver:fail]';
              }
            } else {
              debugMsg += '[exp:fail]';
            }
          } catch (e) { debugMsg += '[err]'; }
          fundedProjects.push({
            project: project.title,
            applicant: applicantName,
            grant: grant.title,
            steps: steps.map(s => ({ name: s.title, completed: !!s.done, due_date: s.due_date })),
            debugMsg
          });
        }
      }
    }
    renderProgressProjectOptions(fundedProjects);
    renderProgressDetails(fundedProjects, 0);
    document.getElementById('funder-progress-project-select').addEventListener('change', function() {
      renderProgressDetails(fundedProjects, this.value);
    });
  }
  function renderProgressProjectOptions(fundedProjects) {
    const select = document.getElementById('funder-progress-project-select');
    select.innerHTML = '';
    fundedProjects.forEach((p, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = `${p.project} (${p.applicant})`;
      select.appendChild(opt);
    });
  }
  function renderProgressDetails(fundedProjects, idx) {
    const details = document.getElementById('funder-progress-details');
    const p = fundedProjects[idx];
    if (!p) {
      details.innerHTML = '<div class="text-cyan-100/80">No project selected.</div>';
      return;
    }
    details.innerHTML = `
      <div class="mb-2 text-cyan-100 font-semibold text-lg">${p.project}</div>
      <div class="mb-2 text-cyan-200">Lead: <span class="text-cyan-300">${p.applicant}</span></div>
      <div class="mb-4 text-cyan-200">Grant: <span class="text-cyan-300">${p.grant}</span></div>
      <div>
        <div class="mb-2 text-cyan-100/80">Project Steps:</div>
        <ul class="list-disc list-inside text-cyan-100/80">
          ${p.steps.length ? p.steps.map(step => `
            <li>
              <span class="${step.completed ? 'text-green-400' : 'text-cyan-200'}">${step.name}</span>
              <span class="text-cyan-400 text-xs ml-2">${step.due_date ? `(Due: ${new Date(step.due_date).toLocaleDateString()})` : ''}</span>
              ${step.completed ? '<i class="fas fa-check-circle text-green-400 ml-2"></i>' : ''}
            </li>
          `).join('') : `<li class=\"text-cyan-400\">No steps found. <span style=\"font-size:10px\">${p.debugMsg || ''}</span></li>`}
        </ul>
      </div>
    `;
  }
  document.addEventListener('DOMContentLoaded', fetchFundedProjectsAndRender);
  </script>
</body>
</html>
